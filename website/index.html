<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VClass</title>

    <link href="https://fonts.googleapis.com/css2?family=Sen:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://vclass.walsted.dev/css/base-styles.css">
</head>
<body>
    <div id="app">
        <div id="useroverlay">
            Welcome <a id="name" name="username">name</a> with the icon <img src="" name="icon" class="circular" height="32" width="32" placeholder="icon" style="-ms-transform: translateY(40%); transform: translateY(40%);">
        </div>

        <div id="setup" class="centered shadow container">
            <div id="setup-user" class="setup-container">
                <div><h2>Setup Account</h2></div>
                <div><img id="icon" name="icon" class="circular" height="128" width="128" onclick="changeColor()"></div>
                <div class="textField"><p>Icon URL:</p>   <input id="iconurl" type="text" onchange="onIconUrlChange()"></input></div>
                <div class="textField"><p>Username:</p>   <input id="username" type="text" placeholder="Username" onchange="onUsernameChange()"></input></div>
                <div class="button" onclick="ToggleContainer()"><p>Confirm</p></div>
                <div><p class="error" id="errorText"></p></div>
            </div>
            <div id="setup-room"  class="setup-container" style="display:none;">
                <div><h2>Enter a Classroom</h2></div>
                <div>
                    <h3>Join Classroom</h3>
                    <div class="textField"><p>Room ID:</p>   <input id="roomID" type="text" placeholder="Room ID"></input></div>
                    <div class="button" onclick="joinRoom()"><p>Join</p></div>
                </div>
                <hr>
                <div>
                    <h3>Create Classroom</h3>
                    <div class="button" onclick="createRoom()"><p>Create</p></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Variables
        var username    = "";
        var iconURL     = "";
        var iconColor   = "";

        // Change Color Variable to random color and update the Icon
        function changeColor (){
            iconColor = (Math.random()*0xFFFFFF<<0).toString(16);
            updateIcon();
        }
        // Called when Icon Url is changed
        function onIconUrlChange (){
            iconURL =  document.getElementById("iconurl").value;
            updateIcon();
            Validate();
        }
        //
        function onUsernameChange(){
            username = document.getElementById("username").value;
            document.getElementById("name").innerHTML = username;
            updateIcon();
            Validate();
        }
        // Changes the icon
        function updateIcon(){
            // If user uses a custom icon
            if(iconURL.length == 0){
                var letter = "?";
                if(username.length > 0){letter = username[0].toUpperCase();}
                document.getElementsByName("icon").forEach((element)=>{
                    element.src = "https://via.placeholder.com/128/" + iconColor +"/ffffff/?text=" + letter;
                })
            }else{
                document.getElementsByName("icon").forEach((element)=>{
                    element.src = iconURL;
                })
            }
        }

        function Validate(){
            if(username.length < 3)
            {
                document.getElementById("errorText").innerHTML = "Username must be at least 3 characters long.";
            }
        }

        function ToggleContainer(){
            document.getElementById("setup-user").style.display = "none";
            document.getElementById("setup-room").style.display = "flex";
            console.log("a");
        }

        function joinRoom() {
            location.href = '/client/client.html?peerId=' + username + "&hostId=" + document.getElementById("roomID").value; 
        }

        function createRoom() {
            location.href = '/host/host.html?peerId=' + username; 
        }
        const getRandomName = async () => {
            let request = new XMLHttpRequest();
            request.open('GET', "https://cors.walsted.dev/http://names.drycodes.com/1?separator=space&format=text");
            let username;
            request.onload = async () => {
                document.getElementById("username").value = await request.response;
            };

            request.send();
            console.log(username);
            return await username;
        }
        const importSteamUser = async (steamid) => {
            let request = new XMLHttpRequest();
            request.open('GET', "https://cors.walsted.dev/https://api.steampowered.com/ISteamUser/GetPlayerSummaries/v2/?key=6FE88E34E12FA3462B9866F27A488AB9&steamids=" + steamid);
            let username;
            request.onload = async () => {
                player = await JSON.parse(request.response).response.players[0];
                document.getElementById("name").innerHTML = player.personaname;
                document.getElementById("username").value = player.personaname;
                iconURL = player.avatarfull;
                updateIcon();
            };
            request.send();
        }
        
        // Sets the username
        getRandomName();
        changeColor();
        (setup = () => {
            username = document.getElementById("username").value;
            document.getElementById("name").innerHTML = username;
            // Joins the selected host if the peer has been created
            if (username != "") {
                updateIcon();
                return;
            }
            setTimeout(setup, 50);
        })()

    </script>
</body>
</html>